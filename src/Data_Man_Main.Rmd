---
title: "Data_Man_Main"
author: "Steven Carrell"
date: "19/11/2019"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath('..'))
```


```{r load project, include = FALSE}
library(ProjectTemplate)
load.project()

```

Head and summary of the Nhanes 2015/2016 dataset
```{r Nhanes head and summary, message = FALSE}
library(knitr)
library(kableExtra)

#First 6 rows of the data set prior to data wrangling.
knitr::kable(head(nhanes.2015.2016, format="latex", booktabs=TRUE)) %>% 
  kable_styling(latex_options="scale_down")

#Summary of data set after data wrangling
summary(nhanes2)

```

## 3 functions created (saved in lib file). 
1. 'corr_func' to quickly test correlations on the variables whilst exploring the data). The sole purpose using this rather than the built-in function is so the argument 'complete.obs' doesn't have to be typed each time. 
2. 'grp_func' to quickly allow the user to input a variable to group by and a variable to analyse which will output the min, max, and mean. 
3. 'prop_func' takes the following aruguments: dataframe, catagorical group variable, and binary variable to analyse. Then outputs a new dataframe of  proportions based on these arguments (split by gender). This will be used in the shiny dashboard.


Below code to firstly find out all the columns containing numeric data (numeric_vars. Then a new data table is created with these values (numeric_data). 
From this table, all the correlations were worked out wit the 'cor' function and saved under a variable names 'correlations'.
A correlation plot was created to clearly show any positive or negative correlations between these variables.
```{r correlation plot, echo=FALSE}

numeric_vars = unlist(lapply(nhanes2, is.numeric))

numeric_data = nhanes2[, ..numeric_vars]

correlations = cor(numeric_data,use = "complete.obs")

#Plot the correlations to clearly visualise how strongly correlated each comparison is
corrplot(correlations)
```


Group by agegrp to look at proportions of people who have and have not smoked 100 cigarettes in their. Assume that the the older generations will have a larger proportion of smokers than the youngers ones. Displayed in pie charts
``` {r proportions of smoked_100}

smoked = prop_func(nhanes2, 'agegroup', 'Smoked_100', percentage = FALSE)

p1 = smoked[1:2,]
p2 = smoked[3:4,]
p3 = smoked[5:6,]
p4 = smoked[7:8,]
p5 = smoked[9:10,]
p6 = smoked[11:12,]

pie1 = ggplot(p1, aes(x='', y=Total_Proportion, fill =Smoked_100 )) + 
  geom_bar(stat='identity', width=1) + labs(title = 'Age - 18-29') + 
  coord_polar('y', start=0) + 
  geom_text(aes(label = percent(Total_Proportion)), position = position_stack(vjust = 0.5), size = 4) +
  scale_fill_brewer(palette = 'Dark2') +
  theme_void()

pie2 = ggplot(p2, aes(x='', y=Total_Proportion, fill =Smoked_100 )) + 
  geom_bar(stat='identity', width=1) + labs(title = 'Age - 30-39') + 
  coord_polar('y', start=0) + 
  geom_text(aes(label = percent(Total_Proportion)), position = position_stack(vjust = 0.5), size = 4) +
  scale_fill_brewer(palette = 'Dark2') +
  theme_void()

pie3 = ggplot(p3, aes(x='', y=Total_Proportion, fill =Smoked_100)) + 
  geom_bar(stat='identity', width=1) + labs(title = 'Age - 40-49') + 
  coord_polar('y', start=0) + 
  geom_text(aes(label = percent(Total_Proportion)), position = position_stack(vjust = 0.5), size = 4) +
  scale_fill_brewer(palette = 'Dark2') +
  theme_void()

pie4 = ggplot(p4, aes(x='', y=Total_Proportion, fill =Smoked_100)) + 
  geom_bar(stat='identity', width=1) + labs(title = 'Age - 50-59') + 
  coord_polar('y', start=0) + 
  geom_text(aes(label = percent(Total_Proportion)), position = position_stack(vjust = 0.5), size = 4) +
  scale_fill_brewer(palette = 'Dark2') +
  theme_void()

pie5 = ggplot(p5, aes(x='', y=Total_Proportion, fill =Smoked_100)) + 
  geom_bar(stat='identity', width=1) + labs(title = 'Age - 60-69') + 
  coord_polar('y', start=0) + 
  geom_text(aes(label = percent(Total_Proportion)), position = position_stack(vjust = 0.5), size = 4) +
  scale_fill_brewer(palette = 'Dark2') +
  theme_void()

pie6 = ggplot(p6, aes(x='', y=Total_Proportion, fill =Smoked_100)) + 
  geom_bar(stat='identity', width=1) + labs(title = 'Age - 70-80+') + 
  coord_polar('y', start=0) + 
  geom_text(aes(label = percent(Total_Proportion)), position = position_stack(vjust = 0.5), size = 4) +
  scale_fill_brewer(palette = 'Dark2') +
  theme_void()


grid.arrange(
  pie1, pie2, pie3, pie4, pie5, pie6, nrow=2, ncol = 3, top = 'Proportion of people who have smoked 100 cigarettes'
)

```

Next test to see if someone with a higher education level is less likely to have smoked 100 cigarettes in their life. 
From the results we can see that as a total proportion between male and female there is not much difference. However if we look at only the males, we see that a college/uni graduate is less likely to have smoked 100 than someone with a lower education.
```{r Proportion function - Education/Smoked_100}
ed_smoke = prop_func(nhanes2, "EducationX", "Smoked_100")
knitr::kable(ed_smoke)

```

Below some box plots and scatter plots have been made influenced by the correlation plot. We hope to find some interetsing results from this. cor_func and grp_func was also used for futher testing. Based on the results some furhter hypothesis testing will be carried out.
```{r box plots and scatter plots1, warning=FALSE}

b1 = ggplot(nhanes2, aes(x=agegroup, y=Systolic_BP1, color=Gender)) + 
  geom_boxplot()
b1
b1_test = filter(nhanes2, Age>69)
b1_func = grp_func(b1_test, 'Gender', 'Systolic_BP1')
knitr::kable(b1_func)
```

Based on the above information 2 hypothesis tests will be carried out. 1 to see if men of all ages have higher Systolic BP than females, and another to test if females aged 70+ have a higher Systolic BP than men. (teststing at bottom of repoort)



```{r box plots and scatter plots2, warning=FALSE}
#Filter dataframe to remove below value
df2 = filter(nhanes2, EducationX !='9')
b2 = ggplot(df2, aes(x=EducationX, y=Income_to_Pov, color=Gender)) + 
  geom_boxplot()
b2

nhanes2$Household_Size = as.factor(nhanes2$Household_Size)
b3 = ggplot(nhanes2, aes(x=Household_Size, y=Income_to_Pov, color=Gender)) + 
  geom_boxplot()
b3
```

Based on the above plot, a hypothesis test will be carried out to see if females living alone earn more than men living on their own.
(test below)


```{r box plots and scatter plots3, warning=FALSE}
b4 = ggplot(nhanes2, aes(x=Race, y=Income_to_Pov, color=Gender)) + 
  geom_boxplot()
b4

#Scatter plots
#Filter dataframe to remove below values
df1 = filter(nhanes2, Smoked_100 !="Don't know" & Smoked_100 !='Refused')

s1 = ggplot(df1, aes(x=Systolic_BP1, y=Systolic_BP2, color = Smoked_100)) + 
  geom_point(alpha=0.2) + 
  scale_color_manual(breaks = c('Yes', 'No'), values = c('blue', 'red'))
s1
corr_func('Systolic_BP1', 'Systolic_BP2')

s2 = ggplot(nhanes2, aes(x=BMXWT, y=Systolic_BP1, color=Gender)) + 
  geom_point(alpha=0.2) +
  scale_color_manual(breaks = c('Male', 'Female'), values = c('blue', 'red'))
s2
corr_func('BMXWT', 'Systolic_BP1')
grp_func(nhanes2, 'Gender', 'BMXBMI')


s3 = ggplot(df1, aes(x=BMXBMI, y=Systolic_BP1, color = Smoked_100)) + 
  geom_point(alpha=0.2) + 
  scale_color_manual(breaks = c('Yes', 'No'), values = c('blue', 'red'))
s3
corr_func('Systolic_BP1', 'BMXBMI')

s4 = ggplot(df1, aes(x=Age, y=Systolic_BP1, color = Smoked_100)) + 
  geom_point(alpha=0.2) + 
  scale_color_manual(breaks = c('Yes', 'No'), values = c('blue', 'red'))
s4
corr_func('Age', 'Systolic_BP1')

grid.arrange(
  s1, s2, s3, s4, nrow=2, ncol = 2, top = 'Testing some correlations'
)

```


Hypothesis testing - all below tests based on significance level of 0.05

T-test to see if male who has smoked 100 cigarettes in his live and had at least 12 alcoholic drinks in 1 year has a higher Systolic blood pressure than a male who has not.
H0 != H1

```{r hypothesis testing}
test1_1 = filter(nhanes2, Gender=='Male' & Smoked_100=='Yes' & Alcohol_Year=='Yes')
test1_2 = filter(nhanes2, Gender=='Male' & Smoked_100=='No' & Alcohol_Year=='No')

#Test using the t.test function
t.test(test1_1$Systolic_BP1, test1_2$Systolic_BP1, alternative = "two.sided", 
       var.equal = FALSE, paired = FALSE)
#Test manually. As the std_dev on each sample are not similar, I have used the 
#unpooled approach
t1_n1 = nrow(test1_1)
t1_n2 = nrow(test1_2)
t1_u1 = mean(test1_1$Systolic_BP1, na.rm = TRUE)
t1_u2 = mean(test1_2$Systolic_BP1, na.rm = TRUE)
t1_sig1 = sd(test1_1$Systolic_BP1, na.rm = TRUE)
t1_sig2 = sd(test1_2$Systolic_BP1, na.rm = TRUE)

t_test = (t1_u1-t1_u2)/sqrt(((t1_sig1^2)/t1_n1)+((t1_sig2^2)/t1_n2))
t_test

#t-score for inbuilt_funtion = 4.6317, t-score worked out manually is 4.73. Both give a p-value of <0.00001 which provides us with sufficient evidence to reject the null hypothesis and say that a male who has drank and smoked does have a higher systolic blood pressure than a male who has not. We can futher back this up by looking at the confidence intervals (2.7, 6.67) and seeing that 0 does not fall within this. Will run similar test for only the alcohol part of this (below)

#T-test to see if somoen who has at least 12 alcoholic drinks in a year has a higher Systolic BP than someone who has not.

test2_1 = filter(nhanes2, Gender=='Male' & Alcohol_Year=='Yes')
test2_2 = filter(nhanes2, Gender=='Male' & Alcohol_Year=='No')

#As the variance is similar (testing below), we will use thr pooled approach
sd(test2_1$Systolic_BP1, na.rm = TRUE)
sd(test2_2$Systolic_BP1, na.rm = TRUE)


t.test(test2_1$Systolic_BP1, test2_2$Systolic_BP1, alternative = 'two.sided', var.equal = TRUE)

#P-value of 0.02299 still provides us with enough evidence to reject the null and conclude that 'on average' people who drink 12 alcoholic drinks per year have a higher systolic BP than those tho don't

#Hypothesis test 3 - Do men of all ages have higher Systolic BP than women.
test3_1 = filter(nhanes2, Gender == 'Male')
test3_2 = filter(nhanes2, Gender == 'Female')

#Testing variance below. As the variance differs, we will use the unpooled approach
sd(test3_1$Systolic_BP1, na.rm = TRUE)
sd(test3_2$Systolic_BP1, na.rm = TRUE)

t.test(test3_1$Systolic_BP1, test3_2$Systolic_BP1, alternative = 'two.sided', var.equal = FALSE)
#Based on this low p-value we reject the null hypothesis.

#Hypothesis test to see if women >69 have a higher Systolic BP than men of the similar age
test4_1 = filter(nhanes2, Gender == 'Female' & Age > 69)
test4_2 = filter(nhanes2, Gender == 'Male' & Age > 69)

#Testing variancwe below. As the variance is similar, the pooled approach will be used
sd(test4_1$Systolic_BP1, na.rm = TRUE)
sd(test4_2$Systolic_BP1, na.rm = TRUE)

t.test(test4_1$Systolic_BP1, test4_2$Systolic_BP1, alternative = 'two.sided', var.equal = TRUE)

#Hypothesis test to see if females living alone earn more than males living alone.
test5_1 = filter(nhanes2, Gender == 'Female' & Household_Size == '1')
test5_2 = filter(nhanes2, Gender == 'Male' & Household_Size == '1')

#Signifincant difference in variance, so we will used the unpooled approach
sd(test5_1$Income_to_Pov, na.rm = TRUE)
sd(test5_2$Income_to_Pov, na.rm = TRUE)

t.test(test5_1$Income_to_Pov, test5_2$Income_to_Pov, alternative = 'two.sided', var.equal = FALSE)

#With a p-value of 0.9063, we fail to reject the null hypothesis based on a significance level of 0.05. Confidence level also includes 0.


```


After some further analysis using the created Shiny dashboard, something interesting was found. Using the interactive box plots we can see that someone who has smoked 100 cigarettes in their life will on average earn less than someone who hasn't. Even more interesting, someone who drinks at least 12 alcoholic drinks per year will earn more on average than somoene who has not (illistrated by the first 2 plots below). Finally the 3rd box plot shows that someone who drinks 12 alcoholic beverages in a year and who has never smoked 100 has a significantly higher income to poverty ratio (on average) than someone who smoked and does not drink.
Based on these finding a hypothesis test will be carried out based on the first 2 plots to see if this is significant enough.
```{r further testing with box plots, warning = FALSE}

df1 = filter(nhanes2, Smoked_100 !="Don't know" & Smoked_100 !='Refused' & Alcohol_Year!="Don't know" & Smoked_100 !='Refused')
b5 = ggplot(df1, aes(x=Smoked_100, y=Income_to_Pov, color=Gender)) + 
  geom_boxplot()
b5

b6 = ggplot(df1, aes(x=Alcohol_Year, y=Income_to_Pov, color=Gender)) + 
  geom_boxplot()
b6

b7 = ggplot(df1, aes(x=Alcohol_Year, y=Income_to_Pov, color=Smoked_100)) + 
  geom_boxplot()
b7

```


2 hypothesis tests. First to see if someone who has smoked 100 earns less than someone who has not, and second to see if someone who drinks 12 in a year earns more than somone who does not. If the results fail to reject the null, a further test will be carried out to see is someone who has not smoked 100 but who does drink at least 12 alcoholic beverages in a year earns more than somoen who smoked 100 and does not drink.

```{r further hypothesis testing}

test6_1 = filter(nhanes2, Smoked_100 == 'Yes')
test6_2 = filter(nhanes2, Smoked_100 == 'No')

#Difference in variance, so we will used the unpooled approach
sd(test6_1$Income_to_Pov, na.rm = TRUE)
sd(test6_2$Income_to_Pov, na.rm = TRUE)

t.test(test6_1$Income_to_Pov, test6_2$Income_to_Pov, alternative = 'two.sided', var.equal = FALSE)

test7_1 = filter(nhanes2, Alcohol_Year == 'Yes')
test7_2 = filter(nhanes2, Alcohol_Year == 'No')

#Difference in variance, so we will used the unpooled approach
sd(test7_1$Income_to_Pov, na.rm = TRUE)
sd(test7_2$Income_to_Pov, na.rm = TRUE)

t.test(test7_1$Income_to_Pov, test7_2$Income_to_Pov, alternative = 'two.sided', var.equal = FALSE)

```

Both of the hypothesis tests reject the null, therefore no need for the third test. With a significance level of 0.05 we can say 'on average' someone who has smoked 100 cigarettes in their life earns less than someone who has not. We can also say that somone who drinks at least 12 alcoholic beverages a year will 'on average' earn more than somoen who does not.


Below box polts for further testing to see if Income, Education and/or Household_Size has on Systolic Blood Pressure

```{r further testing with box plots (Systolic BP), warning = FALSE}

b8 = ggplot(nhanes2, aes(x=Income_Group, y=Systolic_BP1, color=Gender)) + 
  geom_boxplot()
b8

b9 = ggplot(nhanes2, aes(x=EducationX, y=Systolic_BP1, color=Gender)) + 
  geom_boxplot()
b9

b10 = ggplot(nhanes2, aes(x=Household_Size, y=Systolic_BP1, color=Gender)) + 
  geom_boxplot()
b10

```


Box plots indicated little effect income has on Systolic BP. However, both education and household size seem to have an effect.

Below 2 hypothesis tests. First to see if someone with a lower education has a higher systolic blood pressure than someone with a higher education. Second to see if someone living by themselves has a higher systolic blood pressure than someone with a household size of 2.
```{r Further hypothesis testing on Systolic Blood Pressure}
test8_1 = filter(nhanes2, EducationX == '< 9th grade')
test8_2 = filter(nhanes2, EducationX == 'College/Uni graduate or above')

#Difference in variance, so we will used the unpooled approach
sd(test8_1$Systolic_BP1, na.rm = TRUE)
sd(test8_2$Systolic_BP1, na.rm = TRUE)

t.test(test8_1$Income_to_Pov, test8_2$Income_to_Pov, alternative = 'two.sided', var.equal = FALSE)


test9_1 = filter(nhanes2, Household_Size == '1')
test9_2 = filter(nhanes2, Household_Size == '2')

#Variancxe very similar, so we will used the pooled approach
sd(test9_1$Systolic_BP1, na.rm = TRUE)
sd(test9_2$Systolic_BP1, na.rm = TRUE)

t.test(test9_1$Income_to_Pov, test9_2$Income_to_Pov, alternative = 'two.sided', var.equal = TRUE)


```

Both hypothesis tests allow us to reject the null and conclude that 'on average' someone with a lower education has a higher systolic BP than someone with a higher education and also that someone living alone has a higher systolic BP than someone with a household of 2

